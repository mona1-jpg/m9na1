<!DOCTYPE html>

<html>
<head>
  <title>AirSwap.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>AirSwap.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> WebSocket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ws'</span>)
<span class="hljs-keyword">const</span> ethers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ethers'</span>)
<span class="hljs-keyword">const</span> erc20 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'human-standard-token-abi'</span>)
<span class="hljs-keyword">const</span> exchange = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./exchangeABI.json'</span>)
<span class="hljs-keyword">const</span> weth = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./wethABI.json'</span>)
<span class="hljs-keyword">const</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'uuid4'</span>)

<span class="hljs-keyword">const</span> { Contract, Wallet, utils, providers } = ethers

<span class="hljs-keyword">const</span> TIMEOUT = <span class="hljs-number">12000</span>
<span class="hljs-keyword">const</span> INDEXER_ADDRESS = <span class="hljs-string">'0x0000000000000000000000000000000000000000'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="class-constructor">Class Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AirSwap</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <ul>
<li><code>privateKey</code>: <code>string</code> - ethereum private key with <code>&quot;0x&quot;</code> prepended</li>
<li><code>infuraKey</code>: <code>string</code> - infura API key</li>
<li><code>nodeAddress</code>: <code>string</code> - optionally specify a geth/parity node instead of using infura</li>
<li><code>rpcActions</code>: <code>Object</code> - user defined methods; called by peers via JSON-RPC</li>
<li><code>networkId</code>: <code>string</code> - which ethereum network is used; <code>&#39;rinkeby&#39;</code> or <code>&#39;mainnet&#39;</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">constructor</span>(config) {
    <span class="hljs-keyword">const</span> { privateKey, infuraKey, nodeAddress, rpcActions = {}, networkId = <span class="hljs-string">'rinkeby'</span> } = config
    <span class="hljs-keyword">const</span> networkName = networkId === <span class="hljs-string">'mainnet'</span> ? <span class="hljs-string">'homestead'</span> : <span class="hljs-string">'rinkeby'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Create infura provider by default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> provider = <span class="hljs-keyword">new</span> providers.InfuraProvider(networkName, infuraKey)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If user specified, use a geth/parity node instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    provider = nodeAddress ? <span class="hljs-keyword">new</span> providers.JsonRpcProvider(nodeAddress, networkName) : provider</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create an ethereum wallet object for signing orders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.wallet = <span class="hljs-keyword">new</span> Wallet(privateKey, provider)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create an AirSwap contract object based on environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.exchangeContract =
      networkId === <span class="hljs-string">'mainnet'</span>
        ? <span class="hljs-keyword">new</span> Contract(<span class="hljs-string">'0x8fd3121013a07c57f0d69646e86e7a4880b467b7'</span>, exchange.abi, <span class="hljs-keyword">this</span>.wallet)
        : <span class="hljs-keyword">new</span> Contract(<span class="hljs-string">'0x07fc7c43d8168a2730344e5cf958aaecc3b42b41'</span>, exchange.abi, <span class="hljs-keyword">this</span>.wallet)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Create a W-ETH contract object based on environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.wethContract =
      networkId === <span class="hljs-string">'mainnet'</span>
        ? <span class="hljs-keyword">new</span> Contract(<span class="hljs-string">'0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2'</span>, weth.abi, <span class="hljs-keyword">this</span>.wallet)
        : <span class="hljs-keyword">new</span> Contract(<span class="hljs-string">'0xc778417e063141139fce010982780140aa0cd5ab'</span>, weth.abi, <span class="hljs-keyword">this</span>.wallet)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Set the websocket url based on environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.socketUrl =
      networkId === <span class="hljs-string">'mainnet'</span> ? <span class="hljs-string">'wss://connect.airswap-api.com/websocket'</span> : <span class="hljs-string">'wss://sandbox.airswap-api.com/websocket'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Websocket authentication state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.isAuthenticated = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Promise resolvers/rejectors and timeouts for each call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.RESOLVERS = {}
    <span class="hljs-keyword">this</span>.REJECTORS = {}
    <span class="hljs-keyword">this</span>.TIMEOUTS = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>User defined methods that will be invoked by peers on the JSON-RPC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.RPC_METHOD_ACTIONS = rpcActions

    <span class="hljs-keyword">this</span>.getOrders = <span class="hljs-keyword">this</span>.getOrders.bind(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>.fillOrder = <span class="hljs-keyword">this</span>.fillOrder.bind(<span class="hljs-keyword">this</span>)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="rpc-methods">RPC Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Prepare a formatted query to be submitted as a JSON-RPC call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">static</span> makeRPC(method, params = {}, id = uuid()) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,
      method,
      params,
      id,
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Send a JSON-RPC <code>message</code> to a <code>receiver</code> address.
Optionally pass <code>resolve</code> and <code>reject</code> callbacks to handle a response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call(receiver, message, resolve, reject) {
    <span class="hljs-keyword">const</span> messageString = <span class="hljs-built_in">JSON</span>.stringify({
      <span class="hljs-attr">sender</span>: <span class="hljs-keyword">this</span>.wallet.address.toLowerCase(),
      receiver,
      <span class="hljs-attr">message</span>: <span class="hljs-built_in">JSON</span>.stringify(message),
      <span class="hljs-attr">id</span>: uuid(),
    })
    <span class="hljs-keyword">this</span>.socket.send(messageString)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set the promise resolvers and rejectors for this call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resolve === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">this</span>.RESOLVERS[message.id] = resolve
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> reject === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">this</span>.REJECTORS[message.id] = reject
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set a timeout for this call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.TIMEOUTS[message.id] = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> reject === <span class="hljs-string">'function'</span>) {
        reject({ <span class="hljs-attr">message</span>: <span class="hljs-string">`Request timed out. [<span class="hljs-subst">${message.id}</span>]`</span>, <span class="hljs-attr">code</span>: <span class="hljs-number">-1</span> })
      }
    }, TIMEOUT)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="websocket-interaction">WebSocket Interaction</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Connect to AirSwap by opening websocket. The sequence:</p>
<ol>
<li>Open a websocket connection</li>
<li>Receive a challenge (some random data to sign)</li>
<li>Sign the data and send it back over the wire</li>
<li>Receive an “ok” and start sending and receiving RPC</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  connect() {
    <span class="hljs-keyword">this</span>.socket = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-keyword">this</span>.socketUrl)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Check socket health every 30 seconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.socket.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">healthCheck</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.isAlive = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.addEventListener(<span class="hljs-string">'pong'</span>, () =&gt; {
        <span class="hljs-keyword">this</span>.isAlive = <span class="hljs-literal">true</span>
      })

      <span class="hljs-keyword">this</span>.interval = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isAlive === <span class="hljs-literal">false</span>) {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'no response for 30s; closing'</span>)
          <span class="hljs-keyword">this</span>.terminate()
        }
        <span class="hljs-keyword">this</span>.isAlive = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">this</span>.ping()
      }, <span class="hljs-number">30000</span>)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The connection was closed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.socket.onclose = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.isAuthenticated = <span class="hljs-literal">false</span>
      clearInterval(<span class="hljs-keyword">this</span>.socket.interval)
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'socket closed'</span>)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>There was an error on the connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.socket.onerror = <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(event)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Promisify the <code>onmessage</code> handler. Allows us to return information
about the connection state after the authentication handshake</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Received a message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.socket.onmessage = <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>We are authenticating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isAuthenticated) {
          <span class="hljs-keyword">switch</span> (event.data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>We have completed the challenge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">case</span> <span class="hljs-string">'ok'</span>:
              <span class="hljs-keyword">this</span>.isAuthenticated = <span class="hljs-literal">true</span>
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Authentication successful'</span>)
              resolve(event.data)
              <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'not authorized'</span>:
              reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Address is not authorized.'</span>))
              <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>We have been issued a challenge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">this</span>.wallet.signMessage(event.data)
              <span class="hljs-keyword">this</span>.socket.send(signature)
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isAuthenticated) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>We are already authenticated and are receiving an RPC.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">let</span> payload
          <span class="hljs-keyword">let</span> message

          <span class="hljs-keyword">try</span> {
            payload = <span class="hljs-built_in">JSON</span>.parse(event.data)
            message = payload.message &amp;&amp; <span class="hljs-built_in">JSON</span>.parse(payload.message)
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error parsing payload'</span>, e, payload)
          }

          <span class="hljs-keyword">if</span> (!payload || !message) {
            <span class="hljs-keyword">return</span>
          }

          <span class="hljs-keyword">if</span> (message.method) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Another peer is invoking a method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.RPC_METHOD_ACTIONS[message.method]) {
              <span class="hljs-keyword">this</span>.RPC_METHOD_ACTIONS[message.method](message)
            }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.id) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>We have received a response from a method call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">const</span> isError = <span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(message, <span class="hljs-string">'error'</span>)

            <span class="hljs-keyword">if</span> (!isError &amp;&amp; message.result) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Resolve the call if a resolver exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.RESOLVERS[message.id] === <span class="hljs-string">'function'</span>) {
                <span class="hljs-keyword">this</span>.RESOLVERS[message.id](message.result)
              }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isError) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Reject the call if a resolver exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.REJECTORS[message.id] === <span class="hljs-string">'function'</span>) {
                <span class="hljs-keyword">this</span>.REJECTORS[message.id](message.error)
              }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Call lifecycle finished; tear down resolver, rejector, and timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.RESOLVERS[message.id]
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.REJECTORS[message.id]
            clearTimeout(<span class="hljs-keyword">this</span>.TIMEOUTS[message.id])
          }
        }
      }
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Disconnect from AirSwap by closing websocket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  disconnect() {
    <span class="hljs-keyword">this</span>.socket.close(<span class="hljs-number">1000</span>)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h2 id="interacting-with-the-indexer">Interacting with the Indexer</h2>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Query the indexer for trade intents.</p>
<ul>
<li>returns a <code>Promise</code> which is resolved with an array of <code>intents</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findIntents(makerTokens, takerTokens, role = <span class="hljs-string">'maker'</span>) {
    <span class="hljs-keyword">if</span> (!makerTokens || !takerTokens) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'missing arguments makerTokens or takerTokens'</span>)
    }
    <span class="hljs-keyword">const</span> payload = AirSwap.makeRPC(<span class="hljs-string">'findIntents'</span>, {
      makerTokens,
      takerTokens,
      role,
    })

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-keyword">this</span>.call(INDEXER_ADDRESS, payload, resolve, reject))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Call <code>getIntents</code> on the indexer to return an array of tokens that the specified address has published intent to trade</p>
<ul>
<li>parameter <code>address</code> is a lowercased Ethereum address to fetch intents for</li>
<li>returns a <code>Promise</code> which is resolved with getan array of intents</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getIntents(address) {
    <span class="hljs-keyword">const</span> payload = AirSwap.makeRPC(<span class="hljs-string">'getIntents'</span>, { address })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-keyword">this</span>.call(INDEXER_ADDRESS, payload, resolve, reject))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Call <code>setIntents</code> on the indexer with an array of trade <code>intent</code> objects.</p>
<ul>
<li>returns a <code>Promise</code> with the indexer response. Passes <code>&#39;OK&#39;</code> if succcessful.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setIntents(intents) {
    <span class="hljs-keyword">const</span> payload = AirSwap.makeRPC(<span class="hljs-string">'setIntents'</span>, {
      <span class="hljs-attr">address</span>: <span class="hljs-keyword">this</span>.wallet.address.toLowerCase(),
      intents,
    })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-keyword">this</span>.call(INDEXER_ADDRESS, payload, resolve, reject))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Make a JSON-RPC <code>getOrder</code> call on a maker and recieve back a signed order (or a timeout if they fail to respond)</p>
<ul>
<li><code>makerAddress</code>: <code>string</code> - the maker address to request an order from</li>
<li><code>params</code>: <code>Object</code> - order parameters. Must specify 1 of either <code>makerAmount</code> or <code>takerAmount</code>. Must also specify <code>makerToken</code> and <code>takerToken</code> addresses</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getOrder(makerAddress, params) {
    <span class="hljs-keyword">const</span> { makerAmount, takerAmount, makerToken, takerToken } = params
    <span class="hljs-keyword">const</span> BadArgumentsError = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad arguments passed to getOrder'</span>)

    <span class="hljs-keyword">if</span> (!makerAmount &amp;&amp; !takerAmount) <span class="hljs-keyword">throw</span> BadArgumentsError
    <span class="hljs-keyword">if</span> (makerAmount &amp;&amp; takerAmount) <span class="hljs-keyword">throw</span> BadArgumentsError
    <span class="hljs-keyword">if</span> (!takerToken || !makerToken) <span class="hljs-keyword">throw</span> BadArgumentsError

    <span class="hljs-keyword">const</span> payload = AirSwap.makeRPC(<span class="hljs-string">'getOrder'</span>, {
      makerToken,
      takerToken,
      <span class="hljs-attr">takerAddress</span>: <span class="hljs-keyword">this</span>.wallet.address.toLowerCase(),
      <span class="hljs-attr">makerAmount</span>: makerAmount ? <span class="hljs-built_in">String</span>(makerAmount) : <span class="hljs-literal">null</span>,
      <span class="hljs-attr">takerAmount</span>: takerAmount ? <span class="hljs-built_in">String</span>(takerAmount) : <span class="hljs-literal">null</span>,
    })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> <span class="hljs-keyword">this</span>.call(makerAddress, payload, res, rej))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Given an array of trade intents, make a JSON-RPC <code>getOrder</code> call for each <code>intent</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getOrders(intents, makerAmount) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(intents) || !makerAmount) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad arguments passed to getOrders'</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all(
      intents.map(<span class="hljs-function">(<span class="hljs-params">{ address, makerToken, takerToken }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> payload = AirSwap.makeRPC(<span class="hljs-string">'getOrder'</span>, {
          makerToken,
          takerToken,
          <span class="hljs-attr">takerAddress</span>: <span class="hljs-keyword">this</span>.wallet.address.toLowerCase(),
          <span class="hljs-attr">makerAmount</span>: <span class="hljs-built_in">String</span>(makerAmount),
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><code>Promise.all</code> will return a complete array of resolved promises, or just the first rejection if a promise fails.
To mitigate this, we <code>catch</code> errors on individual promises so that <code>Promise.all</code> always returns a complete array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> <span class="hljs-keyword">this</span>.call(address, payload, res, rej)).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e)
      }),
    )
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="interacting-with-ethereum">Interacting with Ethereum</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Return a signed <code>order</code> object for a taker to fill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  signOrder({ makerAddress, makerAmount, makerToken, takerAddress, takerAmount, takerToken, expiration, nonce }) {
    <span class="hljs-keyword">const</span> types = [
      <span class="hljs-string">'address'</span>, <span class="hljs-comment">// makerAddress</span>
      <span class="hljs-string">'uint256'</span>, <span class="hljs-comment">// makerAmount</span>
      <span class="hljs-string">'address'</span>, <span class="hljs-comment">// makerToken</span>
      <span class="hljs-string">'address'</span>, <span class="hljs-comment">// takerAddress</span>
      <span class="hljs-string">'uint256'</span>, <span class="hljs-comment">// takerAmount</span>
      <span class="hljs-string">'address'</span>, <span class="hljs-comment">// takertoken</span>
      <span class="hljs-string">'uint256'</span>, <span class="hljs-comment">// expiration</span>
      <span class="hljs-string">'uint256'</span>, <span class="hljs-comment">// nonce</span>
    ]
    <span class="hljs-keyword">const</span> hashedOrder = utils.solidityKeccak256(types, [
      makerAddress,
      makerAmount,
      makerToken,
      takerAddress,
      takerAmount,
      takerToken,
      expiration,
      nonce,
    ])

    <span class="hljs-keyword">const</span> signedMsg = <span class="hljs-keyword">this</span>.wallet.signMessage(ethers.utils.arrayify(hashedOrder))
    <span class="hljs-keyword">const</span> sig = ethers.utils.splitSignature(signedMsg)

    <span class="hljs-keyword">return</span> {
      makerAddress,
      makerAmount,
      makerToken,
      takerAddress,
      takerAmount,
      takerToken,
      expiration,
      nonce,
      ...sig,
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Submit a signed <code>order</code> object by calling <code>fill</code> on the AirSwap smart contract.</p>
<ul>
<li>optionally pass an object to configure gas settings and amount of ether sent</li>
<li>returns a <code>Promise</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fillOrder(order, config = {}) {
    <span class="hljs-keyword">const</span> { value, gasLimit = <span class="hljs-number">160000</span>, gasPrice = utils.parseEther(<span class="hljs-string">'0.000000040'</span>) } = config

    <span class="hljs-keyword">if</span> (!order.nonce) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad order object'</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.exchangeContract.fill(
      order.makerAddress,
      order.makerAmount,
      order.makerToken,
      order.takerAddress,
      order.takerAmount,
      order.takerToken,
      order.expiration,
      order.nonce,
      order.v,
      order.r,
      order.s,
      {
        <span class="hljs-attr">value</span>: value ? utils.bigNumberify(<span class="hljs-built_in">String</span>(value)) : utils.parseEther(<span class="hljs-string">'0'</span>),
        gasLimit,
        gasPrice,
      },
    )
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Unwrap <code>amount</code> of W-ETH.</p>
<ul>
<li>optionally pass an object to configure gas settings</li>
<li>returns a <code>Promise</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unwrapWeth(amount, config = {}) {
    <span class="hljs-keyword">const</span> { gasLimit = <span class="hljs-number">160000</span>, gasPrice = utils.parseEther(<span class="hljs-string">'0.000000040'</span>) } = config
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.wethContract.withdraw(utils.parseEther(<span class="hljs-built_in">String</span>(amount)), { gasLimit, gasPrice })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Give the AirSwap smart contract permission to transfer an ERC20 token.</p>
<ul>
<li>Must call <code>approveTokenForTrade</code> one time for each token you want to trade</li>
<li>Optionally pass an object to configure gas settings</li>
<li>returns a <code>Promise</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  approveTokenForTrade(tokenContractAddr, config = {}) {
    <span class="hljs-keyword">const</span> { gasLimit = <span class="hljs-number">160000</span>, gasPrice = utils.parseEther(<span class="hljs-string">'0.000000040'</span>) } = config
    <span class="hljs-keyword">const</span> tokenContract = <span class="hljs-keyword">new</span> Contract(tokenContractAddr, erc20, <span class="hljs-keyword">this</span>.wallet)

    <span class="hljs-keyword">return</span> tokenContract.approve(
      <span class="hljs-keyword">this</span>.exchangeContract.address.toLowerCase(),
      <span class="hljs-string">'1000000000000000000000000000'</span>, <span class="hljs-comment">// large approval amount so we don't have to approve ever again</span>
      { gasLimit, gasPrice },
    )
  }
}

<span class="hljs-built_in">module</span>.exports = AirSwap</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
